## 1. 总体设计

### 1.1 概述

此项目为 2023 年春季北京邮电大学操作系统课程设计项目，题目为《操作系统模拟程序的设计与实现》，课程设计的目的在于：加深理解操作系统的基本功能、原理和工作机制，理解并掌握操作系统的实现方法和技术，培养学生理解问题、分析问题、解决问题的能力，培养学生团队合作精神、组织协调能力，进一步培养提高学生的编程实践能力。

#### 1.1.1 功能描述

此项目设计并实现一个具有操作系统基本功能的软件，要求该软件具有操作系统的如下基本功能：

- 进程管理功能，如进程创建(new)、进程调度(scheduling)、进程阻塞(block)、进程唤醒(wakeup)、进程同步(synchronize)等。
- 内存管理功能，进程存储空间的分配和回收等。
- 文件系统，目录/文件的创建和删除、空间分配和回收。
- 设备管理，设备的申请、分配、使用、释放等。
- 程序运行的交互 UI 界面。
- 程序需要模拟实现操作系统的中断机制。

#### 1.1.2 运行环境

程序的运行环境为  *Windows Subsystem for Linux* (*WSL*) ，即 Windows 系统环境下安装的 Linux 虚拟机，所使用的 Linux 发型版为 [Debian 11 (bullseye)](https://www.debian.org/News/2021/20210814), 程序运行的宿主机内核版本为 Linux 5.10.16.3-microsoft-standard-WSL2  x86_64 GNU/Linux。

#### 1.1.3 开发环境

项目使用 VScode 代码编辑器配合 C/C++ 语言相关插件进行开发，团队使用 [Git](https://git-scm.com) 作为代码版本管理工具，代码托管在 [Github](https://github.com) 上的私有远程仓库进行协同开发，所有的代码遵循标准 GNU/Linux 系统 API, 编程语言上使用 C++17 标准进行开发。

### 1.2 设计思想

总体来说，程序使用面向对象的软件工程设计思想进行开发，我们将程序模块化设计，划分为如下几个模块：

1. 系统内存管理模块
2. 系统进程管理模块
3. 系统中断机制模块
4. 文件系统模块
5. 程序交互 UI 界面模块
6. 系统时钟管理 (timer) 模块
7. 系统设备管理模块

#### 1.2.1 软件设计构思

将程序设计划分为上述的几个模块，各个模块之间互相依赖写协作，共同实现操作系统的各个功能。举例来讲，操作系统的内存管理和进程管理为最基础以及最重要的模块，所有的其他模块和功能都要依赖内存管理，以及进程管理功能。与此同时系统的中断机制伴随程序的始终，现代操作系统使用中断驱动，我们将时钟管理模块(timer) 与此结合一起实现。

在交互 UI 界面上，程序在终端模拟一个操作系统 Shell，以及我们自己实现基本的交互指令。举例来说比如 Linux 默认的 `ls` shell 指令作用为列出当前目录下的文件功能。通过这种 Shell 指令与操作系统全程交互，实现用户对操作系统的使用和控制。

对于文件系统模块，设计模拟实现基本的操作系统文件增删读写功能，由于是“模拟”操作系统的功能，所以我们直接使用 Linux 系统提供给用户的底层 API，使用 C/C++ 语言自己更高级的语言特性来调用实现。

现代操作系统同时需要具有设备管理功能，在 Linux 系统下，一切设备都对应一个文件描述符，程序运行开始时刻监听设备的数量，插入已经拔出系统的各种设备等。

#### 1.2.2 关键技术与算法

需要考虑使用何种算法来实现的模块有内存管理模块、进程管理模块、文件系统模块。对于内存管理而言，现代操作系统常见的内存管理算法有三种：连续分区、页式和按需调页。在实现难度上，后两种都要考虑与虚拟内存的交互，但是在我们的“模拟”程序中，实现虚拟内存是内存较大的，所以目前暂定使用连续分页的机制来实现。在后续的团队协作开发进度来看，如果有更充裕的时间我们将考虑更换内存管理算法，比如使用最复杂的按需调页机制。

进程管理部分也有需要选择实现的算法，现代操作系统常见的进程调度算法比如先来先服务FCFS，时间片轮转算法(Round Robin) 算法，多级队列调度算法等。我们暂定使用时间片轮转算法来进程系统进程调度。

文件系统实现部分，使用树形结构等数据结构来维护实现，比如维护文件描述符，我们可以考虑使用哈希表来存储等操作。

#### 1.2.3 基本数据结构

在各种模块算法实现过程中，必然需要借助相对应的数据结构来辅助完成。在进程管理中，我们需要维护一个进程的队列，以时间片轮转算法来说，当一个进程的时间片用完后就回到队尾，队头的进程出队列进行运行，如下图所示 (图源 Wikipedia)：

![image.png](概要设计.assets/WkKHS8tnUBmQNrs.png)

在文件系统或者磁盘管理部分，数据结构也是重度依赖使用的。文件系统主要依赖 FCB 的功能实现，使用多叉树来维护文件结构。磁盘管理功能来说，常见的位示图(bitmap) ，或者使用链表来维护空闲以及被占用的磁盘块，如下图所示为使用 16 bit 序列 `0000111000000110` bitmap 维护的空闲磁盘空间：

<img src="概要设计.assets/1-265.png" alt="image" style="zoom:50%;" />

### 1.3 基本处理流程

对于模拟一个现代的 Linux 操作系统，我们忽略掉硬件启动的部分，对于软件层面包括的处理流程主要为：

1. 内核启动：内核在启动时，首先会进行初始化，包括初始化内存管理、进程管理、文件系统等模块。然后，内核会启动系统的第一个进程 —— systemd，systemd 会负责启动其它服务和进程。对于我们自己模拟的程序，需要自己实现一个初始化程序来初始化所有系统服务。

2. 服务启动：系统初始化进程会启动各种服务，例如网络服务、文件系统服务、用户服务、日志服务等。
3. 进程管理： 系统使用进程来管理程序和服务，内核负责管理进程，包括创建、撤销、调度、通信和同步等操作。
4. 文件管理：操作系统通过文件系统管理文件和目录，支持各种文件系统类型和访问权限设置，包括文件的创建、读取、写入、删除、复制等操作。
5. 设备管理：操作系统会实时监听所有系统识别到的设备，同时映射为系统中的文件描述符。

我们的模拟程序会同时维护上述 5 个流程，以模拟实现现代操作系统的基本功能。



## 2. 软件的体系结构和模块设计

### 2.1 软件的体系结构

#### 2.1.1 软件体系结构框图

#### 2.1.2 软件主要模块及其依赖关系说明

### 2.2 软件数据结构设计

#### 2.2.1 全局数据结构说明

#### 2.2.2 数据结构与系统单元的关系

### 2.3 软件接口设计

#### 2.3.1 外部接口

#### 2.3.2 内部接口





## 3. 用户界面设计

### 3.1 界面的关系图

### 3.2 界面说明

#### 3.2.1 界面1

#### 3.2.2 界面2

#### 3.2.3 界面3



##  4. 相关处理流程

### 4.1 进程管理设计说明

#### 4.1.1 进程管理数据结构说明

* 进程控制块（Process Control Block, PCB）：包含了一个进程的所有信息，包括进程的状态、程序计数器、寄存器信息、内存分配信息、打开文件列表等。

#### 4.1.2 进程管理算法及流程说明

1. 进程调度算法：设计合适的进程调度算法，如先来先服务（FCFS）、最短作业优先（SJF）、轮转法（Round Robin）、优先级调度、多级反馈队列调度等，以合理分配系统资源，实现进程之间的公平调度和优先级管理。
2. 进程状态管理：设计合适的进程状态管理机制，包括进程的创建、启动、运行、阻塞、唤醒和终止等状态的转换和管理，确保进程的正常执行和合理终止。
3. 进程同步和互斥：设计合适的进程同步和互斥机制，包括信号量、互斥锁、条件变量等，以避免进程之间的竞态条件和资源争用问题，保护共享资源的完整性和一致性。
4. 进程间通信：设计合适的进程间通信（Inter-Process Communication, IPC）机制，包括管道、消息队列、共享内存、套接字等，以实现不同进程之间的数据传输和信息交流。

#### 4.1.3 数据存储说明

- 进程信息存储：将进程的相关信息存储在PCB中，包括进程状态、程序计数器、寄存器信息、内存分配信息、打开文件列表等。
- 进程控制数据存储：将进程控制数据存储在操作系统的内存中，以便在进程调度和状态管理时进行快速访问和修改。

### 4.2 内存管理设计说明

#### 4.2.1 内存管理数据结构说明

- 内存分页表（Page Table）：记录进程的虚拟地址空间和物理地址空间之间的映射关系，包括页表项的状态、权限、物理地址等信息。
- 空闲内存管理表（Free Memory Management Table）：记录系统中空闲内存块的位置和大小，用于分配和回收内存。

#### 4.2.2 内存管理算法及流程说明

- 内存分页和分段算法：设计合适的内存分页和分段算法，如固定分页、动态分页、固定分段、动态分段等，以实现虚拟地址空间和物理地址空间之间的映射，实现进程的内存隔离和资源管理。
- 内存分配和回收算法：设计合适的内存分配和回收算法，如首次适应（First Fit）、最佳适应（Best Fit）、最坏适应（Worst Fit）等，以高效地管理空闲内存块，确保内存的有效利用和避免内存碎片问题。

#### 4.2.3 数据存储说明

在内存管理中，需要对内存块的信息进行存储，常用的存储方式有：

- 内存块链表：将内存块组织成链表形式，每个节点存储一个内存块的信息，包括其起始地址和大小信息以及状态（已分配或空闲）等。

### 4.3 中断处理设计说明

#### 4.3.1 中断处理数据结构说明

- 中断向量表（Interrupt Vector Table）：记录系统支持的中断类型和对应的中断处理程序的入口地址，用于在中断发生时进行中断类型识别和中断处理程序的调用。。

#### 4.3.2 中断处理算法及流程说明

- 中断处理程序：设计合适的中断处理程序，包括中断类型的识别、中断处理的优先级管理、中断处理程序的执行和中断返回等流程，以保证系统对中断的及时响应和处理。
- 中断控制：设计合适的中断控制机制，包括中断使能、中断屏蔽、中断优先级设置等，以灵活地管理系统的中断处理流程和优先级。

#### 4.3.3 数据存储说明

* 中断处理数据存储：将中断向量表和中断控制信息存储在操作系统的内存中，以便在中断处理时进行快速访问和修改。

### 4.4 文件系统设计说明

#### 4.4.1 文件系统数据结构说明

- 文件控制块（File Control Block, FCB）：记录文件的属性信息，如文件名、文件大小、文件类型、文件权限等。
- 文件目录（File Directory）：记录系统中所有文件的目录信息，包括文件名、文件属性、文件物理地址等。
- 文件缓存（File Cache）：用于缓存文件的磁盘块数据，加速文件的读写操作。

#### 4.4.2 文件系统算法及流程说明

- 文件的创建、读取、写入、删除等操作：设计合适的文件系统算法，包括文件的创建、读取、写入、删除等操作的流程，确保文件的安全管理和高效操作。
- 文件的权限和访问控制：设计合适的文件权限和访问控制机制，包括文件的读、写、执行权限的设置和管理，以保护文件的安全和隐私。
- 文件的空间管理：设计合适的文件空间管理机制，包括文件的分配、回收和碎片整理等，以确保文件的有效存储和高效访问。

#### 4.4.3 数据存储说明

* 文件系统数据存储：将文件控制块、文件目录和文件缓存等数据存储在磁盘上，使用合适的文件系统结构（如FAT32、NTFS、EXT4等）进行组织和管理，以便在文件的创建、读取、写入和删除等操作时进行快速访问和修改。

### 4.5 设备处理

#### 4.5.1 设备处理数据结构说明

- 设备控制块（Device Control Block, DCB）：记录设备的属性信息，如设备类型、设备状态、设备缓冲区等。
- 设备队列（Device Queue）：记录系统中正在请求和等待设备的进程队列，用于管理设备的分配和调度。
- 设备驱动程序（Device Driver）：负责设备的具体操作，包括设备的初始化、设备的读写、设备的中断处理等。

#### 4.5.2 设备处理算法及流程说明

- 设备的请求和调度：设计合适的设备请求和调度算法，包括设备的请求队列管理、设备的分配和释放、设备的优先级管理等，以确保设备的高效利用和系统对设备的合理调度。
- 设备的中断处理：设计合适的设备中断处理程序，包括设备中断的识别、设备中断的优先级管理、设备中断处理程序的执行和中断返回等流程，以保证设备的及时响应和处理。

#### 4.5.3 数据存储说明

设备处理数据存储：将设备控制块、设备队列和设备驱动程序等数据存储在操作系统的内存中，以便在设备请求和中断处理时进行快速访问和修改。



## 5. 总结



## 参考文献：
